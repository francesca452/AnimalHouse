<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<base href="http://site212225.tw.cs.unibo.it/">
		<title>Ecommerce</title>

		<link rel="stylesheet" href="bootstrap-5.2.0-dist/css/bootstrap.min.css">

		 <script src="bootstrap-5.2.0-dist/js/bootstrap.min.js"></script>
		<script src="jquery-3.6.0.js"></script>

		<script>

			let current_pet = 'dog';

			function set_img_visibility(btn, vis)
			{
				btn.children[0].children[0].style.visibility = vis;
			}

			function setTitle(petImageURL, title)
			{
				$('#pet-page-title').text(title);
				$('#pet-image-title').html(`<img src="${petImageURL}" height="64" alt="">`);
			}

			function setFormAction(productId, formId)
			{
				$(formId).attr('action', `http://site212225.tw.cs.unibo.it/products/${productId}`);
			}

			function sendModifyForm()
			{
				const form = $('#modify-form');
				const action = form.attr('action');

				const mtitle = $('#modify-title');
				const mprice = $('#modify-price');
				const mpieces_left = $('#modify-pieces_left');
				const mdescription = $('#modify-description');

				const data = {
					'title': mtitle.val(),
					'price': mprice.val(),
					'pieces_left': mpieces_left.val(),
					'description': mdescription.val()
				}

				mtitle.val('');
				mprice.val('');
				mpieces_left.val('');
				mdescription.val('');

				$.post(action, data)
				.then(() => {
					getSections(current_pet);
				})
			}

			function sendNewProductForm()
			{
				const form = $('#newProduct-form');

				if (form.find('.required').filter((index, item) => { return item.value === ''}).length > 0) {
					alert('Tutti i campi sono richiesti');
					return;
				}

				const action = form.attr('action');

				const npet = $('#new-pet');
				const nsection= $('#new-section');
				const ntitle = $('#new-title');
				const nprice = $('#new-price');
				const npieces_left = $('#new-pieces_left');
				const ndescription = $('#new-description');
				const nalt = $('#new-alt');

				const newProduct = {
					'pet': npet.val(),
					'section': nsection.val(),
					'title': ntitle.val(),
					'price': nprice.val(),
					'pieces_left': npieces_left.val(),
					'description': ndescription.val(),
					'alt': nalt.val(),
					'image': 'http://www.site.it/'
				}

				npet.val('');
				nsection.val('');
				ntitle.val('');
				nprice.val('');
				npieces_left.val('');
				ndescription.val('');
				nalt.val('');

				$.post(action, newProduct)
				.then(() => {
					getSections(current_pet);
				})
			}

			function deleteProduct(productId)
			{
				$.ajax({
					'url': `http://site212225.tw.cs.unibo.it/products/${productId}`,
					'method': 'DELETE',
				})
				.then((res) => {
					getSections(current_pet);
				})
				.catch((err) => {
					console.error(err);
				})
			}

			function getSections(petQuery)
			{
				$.get(`http://site212225.tw.cs.unibo.it/products?pet=${petQuery}`)
				.then((res) => {
					showSections(res);
				})
				.catch((err)=> {
					console.error(err);
				})
			}

			function showSections(sections)
			{
				const s = $('#sections');
				let innerHTML = '';
				for (let i = 0; i < sections.length; i++) {
					innerHTML += `<h4 class="h2 py-3">${sections[i].section}</h4>`;

					const p = sections[i].products;
					for (let j = 0; j < p.length; j++) {
						innerHTML += `
						<article class="row border-bottom py-3">
							<div class="col-lg-1 col-md-2 col-sm-2 col-2">
								<img src="${p[j].image}" class="img-fluid" alt="${p[j].alt}">
							</div>
							<div class="col">
								<div class="d-flex">
									<h5 class="pe-3">${p[j].title}</h5>
									<span class="pe-2">Prezzo: ${p[j].price}</span>
									<span class="ps-2">Pezzi rimanenti: ${p[j].pieces_left}</span>
								</div>
								<p>${p[j].description}</p>
								<button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#Modify-modal"
								onmouseover="set_img_visibility(this, 'hidden')" 
								onmouseleave="set_img_visibility(this, 'visible')"
								onclick="setFormAction('${p[j]._id}', '#modify-form')">
									Modifica <span><img src="backoffice/img/arrow-2.jpeg" alt="" height="16"></span>
								</button>
								<button class="btn btn-outline-danger" onclick="deleteProduct('${p[j]._id}')">Elimina</button>
							</div>
						</article>`;
					}

					
				}
				s.html(innerHTML);
			}


			$(document).ready(() => {

				/* setup submit button for modify product form in the modal */
				$('#modify-form-submit').click(() => {
					$('#modify-form').submit();
				})

				$('#modify-form').submit(() => {
					sendModifyForm();
					return false; /* prevent change page after submit */
				})

				/* setup submit button for modify product form in the modal */
				$('#newProduct-form-submit').click(() => {
					$('#newProduct-form').submit();
				})

				$('#newProduct-form').submit(() => {
					sendNewProductForm();
					return false;
				})
				
				/* dog is the default page */
				setTitle('/backoffice/img/dog.png', 'Cani');
				getSections('dog');

				$('input[type=radio][name=pet]').change(() => {
					const id = $('input[type=radio][name=pet]:checked').attr('id');
					if (id == 'dog') {
						current_pet = 'dog';
						setTitle('/backoffice/img/dog.png', 'Cani');
						getSections('dog');
					}
				}); 
			});

		</script>
</head>

	<body>
		<header>
			<div class="container-fluid">

				<!-- LOGO e NOME PAGINA -->
				<div class="row d-flex flex-nowrap my-3 px-0 px-sm-5">
					<div class="col-2 col-lg-1">
						<span><img class="img-fluid" src="backoffice/img/company.png" alt="Company logo"></span>
					</div>
					<div class="col-auto d-flex align-items-center">
						<h1>BACK OFFICE APPS</h1>
					</div>
				</div>
				<!-- END logo e nome pagina -->

				<!-- NAVBAR GLOBAL -->
				<div class="row border-top border-bottom border-secondary bg-secondary mt-3 px-0 px-sm-5" style="--bs-bg-opacity: .15;">
					<nav class="navbar navbar-expand-lg" style="padding-top: 4px;padding-bottom: 4px;">
						<div class="container-fluid">
							<a class="navbar-brand" href="backoffice/">Backoffice</a>
							<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
							  <span class="navbar-toggler-icon"></span>
							</button>
							<div class="collapse navbar-collapse" id="navbarNav">
								<ul class="navbar-nav">
									<li class="nav-item">
										<a class="nav-link" href="#">Gestione utenti</a>
									</li>
									<li class="nav-item">
										<a class="nav-link active" aria-current="page" href="backoffice/ecommerce.html">Ecommerce</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" href="#">Serivizi in negozio</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" href="#">Servizi di comunità</a>
									</li>
								</ul>
							</div>
						</div>
					</nav>
				</div>
				<!-- END navbar global -->

				<!-- NAVBAR ECOMMERCE -->
				<div class="row border-bottom bg-light mb-3 px-0 px-sm-5">
					<nav class="navbar navbar-expand-lg mx-0 mx-lg-3" style="padding-top: 1px;padding-bottom: 1px;">
						<div class="container-fluid">
							<a class="navbar-brand active" aria-current="page" href="backoffice/ecommerce.html">Ecommerce</a>
							<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarEcommerce" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle seleziona animale">
								<span class="navbar-toggler-icon"></span>
							</button>
							<div class="collapse navbar-collapse" id="navbarEcommerce">
								<div class="btn-group navbar-nav" role="group" aria-label="Mostra i prodotti per animale selezionato">
									<input type="radio" class="btn-check" name="pet" id="dog" autocomplete="off" checked>
									<label class="btn btn-outline-secondary border-0" for="dog" style="border-radius: 0;">Cani</label>

									<input type="radio" class="btn-check" name="pet" id="cat" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="cat" style="border-radius: 0;">Gatti</label>

									<input type="radio" class="btn-check" name="pet" id="bird" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="bird" style="border-radius: 0;">Volatili</label>

									<input type="radio" class="btn-check" name="pet" id="fish" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="fish" style="border-radius: 0;">Pesci</label>

									<input type="radio" class="btn-check" name="pet" id="turtle" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="turtle" style="border-radius: 0;">Tartarughe</label>

									<input type="radio" class="btn-check" name="pet" id="rodent" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="rodent" style="border-radius: 0;">Roditori</label>

									<input type="radio" class="btn-check" name="pet" id="others" autocomplete="off">
									<label class="btn btn-outline-secondary border-0" for="others" style="border-radius: 0;">Altri animali</label>
								</div>
							</div>
						</div>
					</nav>
				</div>
				<!-- END navbar ecommerce -->

			</div>
		</header>
		<main class="my-5">
			<div class="container">
				<div class="row border-bottom justify-content-between">
					<div class="col-auto">
						<h3>
							<span id="pet-image-title" class="px-3"></span>
							<span id="pet-page-title" class="h1"></span> 
						</h3>
					</div>
					<div class="col-auto">
						<button type="button" data-bs-toggle="modal" data-bs-target="#newProduct-modal" class="btn btn-outline-dark">Aggiungi prodotto</button>
					</div>
				</div>
				<div id="sections">
				</div>

				<!-- modal NUOVO PRODOTTO -->
				<div class="modal fade" id="newProduct-modal" tabindex="-1" aria-labelledby="modal per aggiungere un nuovo prodotto" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
					  		<div class="modal-header">
								<h1 class="modal-title fs-5" id="exampleModalLabel">
									Aggiungi un nuovo prodotto
								</h1>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					  		</div>
					  		<div class="modal-body">

								<form id="newProduct-form" autocomplete="off" class="border-top"  method="POST" action="http://site212225.tw.cs.unibo.it/products/new">

									<label for="new-pet" class="col-form-label">Animale:</label>
									<input required type="text" id="new-pet" name="pet" class="form-control required" aria-describedby="Animale per cui è il prodotto">

									<label for="new-section" class="col-form-label">Sezione:</label>
									<input required type="text" id="new-section" name="title" class="form-control required" aria-describedby="Sezione del prodotto">

									<label for="new-title" class="col-form-label">Nome Prodotto:</label>
									<input required type="text" id="new-title" name="title" class="form-control required" aria-describedby="Nome prodotto">

									<label for="new-price" class="col-form-label">Prezzo:</label>
									<input required type="text" id="new-price" name="price" class="form-control required" aria-describedby="Prezzo">

									<label for="new-pieces_left" class="col-form-label">Pezzi rimanenti:</label>
									<input required type="text" id="new-pieces_left" name="pieces_left" class="form-control required" aria-describedby="Pezzi rimanenti">

									<label for="new-alt" class="col-form-label">Testo alternativo all'immagine:</label>
									<input required type="text" id="new-alt" name="alt" class="form-control required" aria-describedby="Alt immagine">

									<label for="new-description" class="col-form-label">Descrizione:</label>
									<textarea required id="new-description" name="description" class="form-control required" aria-describedby="Descrizione"></textarea>
								</form>
	
					  		</div>
					  		<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
								<button type="submit" id="newProduct-form-submit" data-bs-dismiss="modal" class="btn btn-success">Salva</button>
					  		</div>
						</div>
					</div>
				</div>

			<!-- END modal nuovo prodotto -->

				<!-- Modal FORM MODIFICA -->
				<div class="modal fade" id="Modify-modal" tabindex="-1" aria-labelledby="modal di modifica del prodotto" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
					  		<div class="modal-header">
								<h1 class="modal-title fs-5" id="exampleModalLabel">
									Modifica prodotto: <span id="modal-title-prodcut"></span>
								</h1>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					  		</div>
					  		<div class="modal-body">

							<p>I campi lasciati bianchi non vengono modificati</p>

							<!-- form modifica -->
							<form id="modify-form" autocomplete="off" class="border-top"  method="POST" action="https://site212225.tw.cs.unibo.it/products/">
								<label for="modify-title" class="col-form-label">Nome Prodotto:</label>
								<input type="text" id="modify-title" name="title" class="form-control" aria-describedby="Nome prodotto">

								<label for="modify-price" class="col-form-label">Prezzo:</label>
								<input type="text" id="modify-price" name="price" class="form-control" aria-describedby="Prezzo">

								<label for="modify-pieces_left" class="col-form-label">Pezzi rimanenti:</label>
								<input type="text" id="modify-pieces_left" name="pieces_left" class="form-control" aria-describedby="Pezzi rimanenti">

								<label for="modify-description" class="col-form-label">Descrizione:</label>
								<textarea id="modify-description" name="description" class="form-control" aria-describedby="Descrizione"></textarea>
							</form>

							<!-- END form modifica -->
					  	</div>
					  	<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
							<button type="submit" id="modify-form-submit" data-bs-dismiss="modal" class="btn btn-success">Salva</button>
					  	</div>
					</div>
				</div>
			</div>
				<!-- END modal -->

			</div>
		</main>
		<footer class="border-top bg-secondary" style="--bs-bg-opacity: .1">
			<div class="container-fluid py-5">
				<p class="text-center">Questa è una frase finale per riempire lo spazio del footer</p>
			</div>
		</footer>
	</body>
</html>
